<!DOCTYPE html>
<html lang="en">

<head>
  <title>Task Search - Active Search with Infinite Scroll</title>

  <script src="https://unpkg.com/htmx.org@2.0.6"></script>
</head>

<style>

  table {
    width: 100%;
    table-layout: fixed;
    text-align: left;
    border: 1px solid grey;
  }

  tbody tr:hover {
    background-color: lightgrey;
  }

  th {
    border: 1px solid grey;
  }

  td {
    border: 1px solid grey;
  }

  th:first-child {
    width: 67%;
    max-width: 67%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .form-field {
    padding-right: 1em;
    display: flex;
    flex-direction: column;
  }

</style>

<body>

  <h1>Task Search - Active Search with Infinite Scroll!</h1>

  <div style="display: flex; padding-bottom: 1em;">

    <div class="form-field">
      <label for="name">Name:</label>
      <input id="name" name="name" type="search" value="{{.QueryParams.name}}" autocomplete="on" autofocus hx-get="/tasks"
        hx-include="input, select" hx-trigger="search, keyup changed delay:500ms"
        hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner" />
    </div>

      <!-- #name_search_type only triggers the request when #name isn't empty; see htmx:configRequest <script> at page's bottom -->
    <div class="form-field">
      <label for="name_search_type">Name Search Type:</label>
      <select id="name_search_type" name="nameSearchType" value="{{.QueryParams.nameSearchType}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
        <option value="contains" {{if eq .QueryParams.nameSearchType "contains" }}selected{{end}}>CONTAINS</option>
        <option value="startsWith" {{if eq .QueryParams.nameSearchType "startsWith" }}selected{{end}}>STARTS WITH
        </option>
        <option value="endsWith" {{if eq .QueryParams.nameSearchType "endsWith" }}selected{{end}}>ENDS WITH</option>
      </select>
    </div>

    <div class="form-field">
      <label for="priority_select">Priority:</label>
      <select id="priority_select" name="priority" value="{{.QueryParams.priority}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
        {{range $k, $p := .Priorities}}
        <option value={{$p.Value}} {{if eq $.QueryParams.priority $p.Value}}selected{{end}}>{{$p.TagContent}}
        </option>
        {{end}}
      </select>
    </div>

    <div class="form-field">
      <label for="status_select">Status:</label>
      <select id="status_select" name="status" value="{{.QueryParams.status}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
        {{ range $k, $s := .Statuses}}
        <option value={{$s.Value}} {{if eq $.QueryParams.status $s.Value}}selected{{end}}>{{$s.TagContent}}</option>
        {{end}}
      </select>
    </div>

    <div class="form-field">
      <label for="due_date_search_type_select">Due Date Search Type:</label>
      <select id="due_date_search_type_select" name="dueDateSearchType" onchange="handleDueDateSearchTypeSelectChange(this.value)">
        <option value="year" {{if eq .QueryParams.dueDateSearchType "year" }}selected{{end}}>Year</option>
        <option value="month" {{if eq .QueryParams.dueDateSearchType "month" }}selected{{end}}>Month</option>
        <option value="day" {{if eq .QueryParams.dueDateSearchType "day" }}selected{{end}}>Day</option>
      </select>
    </div>

    <div class="form-field">
      <label id="due_date_label"
          {{if eq .QueryParams.dueDateSearchType "month" }}
              for="due_date_year_month_input"
          {{else if eq .QueryParams.dueDateSearchType "day" }}
              for="due_date_year_month_day_input"
          {{else}}
              for="due_date_year_input"
          {{end}}
      >Due Date:</label>

      <input id="due_date_year_input" type="number" min="2020" max="2030"
          {{if or (not .QueryParams.dueDateSearchType) (eq .QueryParams.dueDateSearchType "year") }}
              value="{{.QueryParams.dueDate}}"
          {{else}}
              value="" disabled hidden
          {{end}}
          onchange="onDueDateChange(this.value)">

      <input id="due_date_year_month_input" type="month" min="2020-01" max="2030-12"
          {{if eq .QueryParams.dueDateSearchType "month" }}
              value="{{.QueryParams.dueDate}}"
          {{else}}
              value="" disabled hidden
          {{end}}
          onchange="onDueDateChange(this.value)">

      <input id="due_date_year_month_day_input" type="date" min="2020-01-01" max="2030-12-31"
          {{if eq .QueryParams.dueDateSearchType "day" }}
              value="{{.QueryParams.dueDate}}"
          {{else}}
              value="" disabled hidden
          {{end}}
          onchange="onDueDateChange(this.value)">

      <input id="due_date_input" type="hidden" name="dueDate" value="{{.QueryParams.dueDate}}" hx-trigger="change"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
    </div>

    <div class="form-field">
      <label for="sort_column_select">Sort By:</label>
      <select id="sort_column_select" name="otherCursorColumn"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
        {{range $k, $s := .SortColumnSelectOptions}}
        <option value="{{$s.Value}}" {{if eq $.QueryParams.otherCursorColumn $s.Value}}selected{{end}}
            {{if and (not $.QueryParams.otherCursorColumn) (eq $s.Value "name")}}selected{{end}}>{{$s.TagContent}}
        </option>
        {{end}}
      </select>
    </div>

    <div class="form-field">
      <label for="sort_order_select">Order:</label>
      <select id="sort_order_select" name="sortOrder"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true" hx-indicator="#seach_spinner">
        <option value="asc" {{if eq $.QueryParams.sortOrder "asc" }}selected{{end}}>ASC</option>
        <option value="desc" {{if eq $.QueryParams.sortOrder "desc" }}selected{{end}}>DESC</option>
      </select>
    </div>

    <div id="seach_spinner" class="form-field htmx-indicator">
      <br/>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor"
          d="M12,23a9.63,9.63,0,0,1-8-9.5,9.51,9.51,0,0,1,6.79-9.1A1.66,1.66,0,0,0,12,2.81h0a1.67,1.67,0,0,0-1.94-1.64A11,11,0,0,0,12,23Z">
          <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate"
            values="0 12 12;360 12 12" />
        </path>
      </svg>
    </div>

  </div>

  <div style="display: flex; padding-bottom: 1em;"
      hx-get="/task-count"
      hx-include="[name='name'], [name='nameSearchType'], [name='priority'], [name='status'], [name='dueDate']"
      hx-trigger="load, countTasks from:body"
      hx-target="#task_count_div"
      hx-indicator="#task_count_spinner">
    <div id="task_count_div"></div>
    <div id="task_count_spinner" style="padding-left: 1em;" class="htmx-indicator">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor"
          d="M12,23a9.63,9.63,0,0,1-8-9.5,9.51,9.51,0,0,1,6.79-9.1A1.66,1.66,0,0,0,12,2.81h0a1.67,1.67,0,0,0-1.94-1.64A11,11,0,0,0,12,23Z">
          <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate"
            values="0 12 12;360 12 12" />
        </path>
      </svg>
    </div>

  </div>

  <table>

    <thead>
      <tr>
        <th>Name</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Due Date</th>
      </tr>
    </thead>

    <tbody>
      {{range $idx, $val := .Tasks}}
      {{if eq $idx 24}}
      <tr hx-get="/tasks" 
          hx-include="input, select"
          hx-vals='{"idCursorValue": "{{$val.ID}}", "otherCursorValue": "{{$.OtherCursorValueStr}}"}'
          hx-trigger="revealed"
          hx-swap="outerHTML" 
          hx-indicator="#below_table_spinner">
      {{else}}
      <tr>
      {{end}}
        <td>{{$val.Name}}</td>
        <td>
          {{if eq $val.Priority 1}}
          LOW
          {{else if eq $val.Priority 2}}
          MEDIUM
          {{else if eq $val.Priority 3}}
          HIGH
          {{end}}
        </td>
        <td>
          {{if eq $val.Status 1}}
          NEW
          {{else if eq $val.Status 2}}
          STARTED
          {{else if eq $val.Status 3}}
          BLOCKED
          {{else if eq $val.Status 4}}
          DONE
          {{end}}
        </td>
        <td>{{$val.DueDate}}</td>
      </tr>
      {{end}}
    </tbody>

  </table>

  <div id="below_table_spinner" style="padding-left: 1em; padding-top: 0.5em;" class="htmx-indicator">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
      <path fill="currentColor"
        d="M12,23a9.63,9.63,0,0,1-8-9.5,9.51,9.51,0,0,1,6.79-9.1A1.66,1.66,0,0,0,12,2.81h0a1.67,1.67,0,0,0-1.94-1.64A11,11,0,0,0,12,23Z">
        <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate"
          values="0 12 12;360 12 12" />
      </path>
    </svg>
  </div>

  <script>

    const dueDateInput = document.getElementById('due_date_input');

    function handleDueDateSearchTypeSelectChange(value) {
      const dueDateYearInput = document.getElementById('due_date_year_input');
      const dueDateYearMonthInput = document.getElementById('due_date_year_month_input');
      const dueDateYearMonthDayInput = document.getElementById('due_date_year_month_day_input');
      const dueDateLabel = document.getElementById("due_date_label");

      if (dueDateInput.value != '') {
        onDueDateChange('');
      }

      dueDateYearInput.value = '';
      dueDateYearMonthInput.value = '';
      dueDateYearMonthDayInput.value = '';

      switch (value) {
        case 'year':
          dueDateYearInput.removeAttribute('disabled');
          dueDateYearInput.removeAttribute('hidden');
          dueDateYearMonthInput.setAttribute('disabled', '');
          dueDateYearMonthInput.setAttribute('hidden', '');
          dueDateYearMonthDayInput.setAttribute('disabled', '');
          dueDateYearMonthDayInput.setAttribute('hidden', '');
          dueDateLabel.setAttribute('for', 'due_date_year_input');
          break;
        case 'month':
          dueDateYearInput.setAttribute('disabled', '');
          dueDateYearInput.setAttribute('hidden', '');
          dueDateYearMonthInput.removeAttribute('disabled');
          dueDateYearMonthInput.removeAttribute('hidden');
          dueDateYearMonthDayInput.setAttribute('disabled', '');
          dueDateYearMonthDayInput.setAttribute('hidden', '');
          dueDateLabel.setAttribute('for', 'due_date_year_month_input');
          break;
        default:
          dueDateYearInput.setAttribute('disabled', '');
          dueDateYearInput.setAttribute('hidden', '');
          dueDateYearMonthInput.setAttribute('disabled', '');
          dueDateYearMonthInput.setAttribute('hidden', '');
          dueDateYearMonthDayInput.removeAttribute('disabled');
          dueDateYearMonthDayInput.removeAttribute('hidden');
          dueDateLabel.setAttribute('for', 'due_date_year_month_day_input');
          break;
      }
    }

    function onDueDateChange(value) {
      dueDateInput.setAttribute('value', value);
      htmx.trigger('#due_date_input', 'change');
    }

    htmx.config.timeout = 30_000;

    document.body.addEventListener('htmx:timeout', function() {
      alert('Request timed out.');
    });

    document.body.addEventListener('htmx:responseError', function(event) {
      const xhr = event.detail.xhr;
      alert(xhr.status + ' ' + xhr.statusText);
    });

    document.body.addEventListener('htmx:sendError', function(event) {
      alert('A nework error occurred');
    });

    document.addEventListener('htmx:configRequest', function(event) {
      const nameInputValue = event.detail.formData.get('name');
      const nameInputValueIsNullOrEmpty = (nameInputValue == null || nameInputValue == '');

      if (nameInputValueIsNullOrEmpty
            && event.detail.path == '/tasks'
            && event.detail.verb == 'get'
            && event.detail.elt.id == 'name_search_type') {
        event.preventDefault();
      }
    });

  </script>

</body>

</html>
