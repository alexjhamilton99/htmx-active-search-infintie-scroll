<!DOCTYPE html>
<html lang="en">

<head>
  <title>Task Search - Active Search with Infinite Scroll</title>

  <script src="https://unpkg.com/htmx.org@2.0.6"></script>
</head>

<style>

  table {
    width: 100%;
    table-layout: fixed;
    text-align: left;
    border: 1px solid grey;
  }

  tr:hover {
    background-color: lightgrey;
  }

  th {
    border: 1px solid grey;
  }

  td {
    border: 1px solid grey;
  }

  th:first-child {
    width: 67%;
    max-width: 67%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

</style>

<body>

  <h1>Task Search - Active Search with Infinite Scroll!</h1>

  <div style="display: flex; padding-bottom: 1em;">

    <div style="padding-right: 1em;">
      <label for="name">Name:</label>
      <input id="name" name="name" type="search" value="{{.QueryParams.name}}" autocomplete="on" autofocus hx-get="/tasks"
        hx-include="input, select" hx-trigger="keyup changed delay:500ms"
        hx-target="tbody" hx-push-url="true" hx-indicator="#table_spinner" />
    </div>

    <div style="padding-right: 1em;">
      <label for="name_search_type">Name Search Type:</label>
      <select id="name_search_type" name="nameSearchType" value="{{.QueryParams.nameSearchType}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        <option value="contains" {{if eq .QueryParams.nameSearchType "contains" }}selected{{end}}>CONTAINS</option>
        <option value="startsWith" {{if eq .QueryParams.nameSearchType "startsWith" }}selected{{end}}>STARTS WITH
        </option>
        <option value="endsWith" {{if eq .QueryParams.nameSearchType "endsWith" }}selected{{end}}>ENDS WITH</option>
      </select>
    </div>

    <div style="padding-right: 1em;">
      <label for="priority_select">Priority:</label>
      <select id="priority_select" name="priority" value="{{.QueryParams.priority}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        {{range $k, $p := .Priorities}}
        <option value={{$p.Value}} {{if eq $.QueryParams.priority $p.Value}}selected{{end}}>{{$p.TagContent}}
        </option>
        {{end}}
      </select>
    </div>

    <div style="padding-right: 1em;">
      <label for="status_select">Status:</label>
      <select id="status_select" name="status" value="{{.QueryParams.status}}"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        {{ range $k, $s := .Statuses}}
        <option value={{$s.Value}} {{if eq $.QueryParams.status $s.Value}}selected{{end}}>{{$s.TagContent}}</option>
        {{end}}
      </select>
    </div>

    <div style="padding-right: 1em;">
      <label for="due_date_search_type_select">Due Date Search Type:</label>
      <select id="due_date_search_type_select" name="due_date_search_type" onchange="handleDueDateSearchTypeSelectChange(this.value)"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        <option value="year">Year</option>
        <option value="month">Month</option>
        <option value="day">Day</option>
      </select>
    </div>

    <div style="padding-right: 1em;">
      <label id="due_date_label" for="due_date_year_input">Due Date:</label>
      {{if not .QueryParams.dueDate}}
      <input id="due_date_year_input" type="number" name="dueDate" min="2020" max="2030" value=""
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      <input id="due_date_year_month_input" type="month" name="dueDate" min="2020-01" max="2030-12" value="" disabled hidden
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      <input id="due_date_year_month_day_input" type="date" name="dueDate" min="2020-01-01" max="2030-12-31" value="" disabled hidden
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      {{else}}
      <input id="due_date_year_input" type="number" name="dueDate" min="2020" max="2030" 
          {{if gt (len .QueryParams.dueDate) 4}}disabled{{else}} value="{{.QueryParams.dueDate}}" {{end}}
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      <input id="due_date_year_month_input" type="month" name="dueDate" min="2020-01" max="2030-12"
          {{if ne (len .QueryParams.dueDate) 7}}disabled{{else}} value="{{.QueryParams.dueDate}}" {{end}}
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      <input id="due_date_year_month_day_input" type="date" name="dueDate" min="2020-01-01" max="2030-12-31"
          {{if lt (len .QueryParams.dueDate) 10}}disabled{{else}} value="{{.QueryParams.dueDate}}" {{end}}
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
      {{end}}
    </div>

    <div style="padding-right: 1em;">
      <label for="sort_column_select">Sort By:</label>
      <select id="sort_column_select" name="otherCursorColumn"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        {{range $k, $s := .SortColumnSelectOptions}}
        <option value="{{$s.Value}}" {{if eq $.QueryParams.otherCursorColumn $s.Value}}selected{{end}}
            {{if and (not $.QueryParams.otherCursorColumn) (eq $s.Value "name")}}selected{{end}}>{{$s.TagContent}}
        </option>
        {{end}}
      </select>
    </div>

    <div>
      <label for="sort_order_select">Order:</label>
      <select id="sort_order_select" name="sortOrder"
          hx-get="/tasks" hx-include="input, select" hx-target="tbody" hx-push-url="true">
        <option value="asc" {{if eq $.QueryParams.sortOrder "asc" }}selected{{end}}>ASC</option>
        <option value="desc" {{if eq $.QueryParams.sortOrder "desc" }}selected{{end}}>DESC</option>
      </select>
    </div>

  </div>

  <div style="display: flex; padding-bottom: 1em;"
      hx-get="/task-count"
      hx-include="[name='name'], [name='nameSearchType'], [name='priority'], [name='status'], [name='dueDate']"
      hx-trigger="load, countTasks from:body"
      hx-target="#task_count_div"
      hx-indicator="#task_count_spinner">
    <div id="task_count_div"></div>
    <div id="task_count_spinner" style="padding-left: 1em;" class="htmx-indicator">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="currentColor"
          d="M12,23a9.63,9.63,0,0,1-8-9.5,9.51,9.51,0,0,1,6.79-9.1A1.66,1.66,0,0,0,12,2.81h0a1.67,1.67,0,0,0-1.94-1.64A11,11,0,0,0,12,23Z">
          <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate"
            values="0 12 12;360 12 12" />
        </path>
      </svg>
    </div>
  </div>

  <table>

    <thead>
      <tr>
        <th>Name</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Due Date</th>
      </tr>
    </thead>

    <tbody>
      {{range $idx, $val := .Tasks}}
      {{if eq $idx 24}}
      <tr hx-get="/tasks" 
          hx-include="input, select"
          hx-vals='{"idCursorValue": "{{$val.ID}}", "otherCursorValue": "{{$.OtherCursorValueStr}}"}'
          hx-trigger="revealed"
          hx-swap="outerHTML" 
          hx-indicator="#table_spinner">
      {{else}}
      <tr>
      {{end}}
        <td>{{$val.Name}}</td>
        <td>
          {{if eq $val.Priority 1}}
          LOW
          {{else if eq $val.Priority 2}}
          MEDIUM
          {{else if eq $val.Priority 3}}
          HIGH
          {{end}}
        </td>
        <td>
          {{if eq $val.Status 1}}
          NEW
          {{else if eq $val.Status 2}}
          STARTED
          {{else if eq $val.Status 3}}
          BLOCKED
          {{else if eq $val.Status 4}}
          DONE
          {{end}}
        </td>
        <td>{{$val.DueDate}}</td>
      </tr>
      {{end}}
    </tbody>

  </table>

  <div id="table_spinner" style="padding-left: 1em; padding-top: 0.5em;" class="htmx-indicator">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
      <path fill="currentColor"
        d="M12,23a9.63,9.63,0,0,1-8-9.5,9.51,9.51,0,0,1,6.79-9.1A1.66,1.66,0,0,0,12,2.81h0a1.67,1.67,0,0,0-1.94-1.64A11,11,0,0,0,12,23Z">
        <animateTransform attributeName="transform" dur="0.75s" repeatCount="indefinite" type="rotate"
          values="0 12 12;360 12 12" />
      </path>
    </svg>
  </div>

  <script>

    const dueDateYearInput = document.getElementById("due_date_year_input");
    const dueDateYearMonthInput = document.getElementById("due_date_year_month_input");
    const dueDateYearMonthDayInput = document.getElementById("due_date_year_month_day_input");
    const dueDateLabel = document.getElementById("due_date_label");

    onload = (event) => {
      const urlSearchParams = new URLSearchParams(document.location.search);
      const dueDate = "dueDate"
      
      if (urlSearchParams.has(dueDate)) {
        const dueDateQueryParam = urlSearchParams.get(dueDate);
        switch (dueDateQueryParam.length) {
          case 4:
            dueDateYearInput.value = dueDateQueryParam;
            dueDateYearMonthInput.setAttribute("disabled", "");
            dueDateYearMonthInput.setAttribute("hidden", "");
            dueDateYearMonthDayInput.setAttribute("disabled", "");
            dueDateYearMonthDayInput.setAttribute("hidden", "");
            dueDateLabel.setAttribute("for", "due_date_year_input");
            break;
          case 7:
            dueDateYearMonthInput.value = dueDateQueryParam;
            dueDateYearInput.setAttribute("disabled", "");
            dueDateYearInput.setAttribute("hidden", "");
            dueDateYearMonthDayInput.setAttribute("disabled", "");
            dueDateYearMonthDayInput.setAttribute("hidden", "");
            dueDateLabel.setAttribute("for", "due_date_year_month_input");
            break;
          default:
            dueDateYearMonthDayInput.value = dueDateQueryParam;
            dueDateYearInput.setAttribute("disabled", "");
            dueDateYearInput.setAttribute("hidden", "");
            dueDateYearMonthInput.setAttribute("disabled", "");
            dueDateYearMonthInput.setAttribute("hidden", "");
            dueDateLabel.setAttribute("for", "due_date_year_month_day_input");
            break;
        };
      }
    };

    function handleDueDateSearchTypeSelectChange(value) {
      switch (value) {
        case "year":
          dueDateYearInput.removeAttribute("disabled");
          dueDateYearInput.removeAttribute("hidden");
          dueDateYearMonthInput.setAttribute("disabled", "");
          dueDateYearMonthInput.setAttribute("hidden", "");
          dueDateYearMonthDayInput.setAttribute("disabled", "");
          dueDateYearMonthDayInput.setAttribute("hidden", "");
          dueDateLabel.setAttribute("for", "due_date_year_input");
          break;
        case "month":
          dueDateYearInput.setAttribute("disabled", "");
          dueDateYearInput.setAttribute("hidden", "");
          dueDateYearMonthInput.removeAttribute("disabled");
          dueDateYearMonthInput.removeAttribute("hidden");
          dueDateYearMonthDayInput.setAttribute("disabled", "");
          dueDateYearMonthDayInput.setAttribute("hidden", "");
          dueDateLabel.setAttribute("for", "due_date_year_month_input");
          break;
        default:
          dueDateYearInput.setAttribute("disabled", "");
          dueDateYearInput.setAttribute("hidden", "");
          dueDateYearMonthInput.setAttribute("disabled", "");
          dueDateYearMonthInput.setAttribute("hidden", "");
          dueDateYearMonthDayInput.removeAttribute("disabled");
          dueDateYearMonthDayInput.removeAttribute("hidden");
          dueDateLabel.setAttribute("for", "due_date_year_month_day_input");
          break;
      }
    }

    htmx.config.timeout = 30_000;

    document.body.addEventListener('htmx:timeout', function() {
      alert('Request timed out.');
    });

    document.body.addEventListener('htmx:responseError', function(event) {
      const xhr = event.detail.xhr;
      alert(xhr.status + ' ' + xhr.statusText);
    });

    document.body.addEventListener('htmx:sendError', function(event) {
      alert('A nework error occurred');
    });

  </script>

</body>

</html>
